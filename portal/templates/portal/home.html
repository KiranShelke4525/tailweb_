<!DOCTYPE html>
<html>
  <head>
    <title>Teacher Portal - Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #f3f3f3;
      }
      .modal-content {
        border-radius: 10px;
      }
      .dropdown-menu {
        min-width: 100px;
        font-size: 14px;
      }
      .dropdown-item {
        padding: 6px 12px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-4">Welcome to Teacher Portal {{ username }}</h3>
        <a href="{% url 'logout' %}" class="btn btn-outline-secondary"
          >Logout</a
        >
      </div>

      <button
        class="btn btn-dark mb-3"
        data-toggle="modal"
        data-target="#addStudentModal"
      >
        Add
      </button>

      <table class="table table-bordered">
        <thead class="thead-light">
          <tr>
            <th>Name</th>
            <th>Subject</th>
            <th>Mark</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="studentTable">
          {% for student in students %}
          <tr data-id="{{ student.id }}">
            <td class="student-name">{{ student.name }}</td>
            <td class="student-subject">{{ student.subject }}</td>
            <td class="student-marks">{{ student.marks }}</td>
            <td>
              <div class="dropdown d-inline-block">
                <button
                  class="btn btn-outline-dark dropdown-toggle btn-sm"
                  type="button"
                  data-toggle="dropdown"
                >
                  â–¼
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                  <a class="dropdown-item" href="#" onclick="editRow(this)"
                    >Edit</a
                  >
                  <a
                    class="dropdown-item text-danger"
                    href="#"
                    onclick="deleteStudent({{ student.id }})"
                    >Delete</a
                  >
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div
      class="modal fade"
      id="addStudentModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="addStudentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <form id="addStudentForm" class="w-100">
          <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-0">
              <h5 class="modal-title">Add Student</h5>
              <button
                type="button"
                class="close text-white"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span>&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label class="text-white">Name</label>
                <input
                  type="text"
                  id="studentName"
                  class="form-control bg-light text-dark"
                  required
                />
              </div>
              <div class="form-group">
                <label class="text-white">Subject</label>
                <input
                  type="text"
                  id="studentSubject"
                  class="form-control bg-light text-dark"
                  required
                />
              </div>
              <div class="form-group">
                <label class="text-white">Marks</label>
                <input
                  type="number"
                  id="studentMarks"
                  class="form-control bg-light text-dark"
                  required
                />
              </div>
            </div>
            <div class="modal-footer border-0">
              <button type="submit" class="btn btn-light btn-block w-100">
                Add
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div
      class="modal fade"
      id="editStudentModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="editStudentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <form id="editStudentForm" class="w-100">
          <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-0">
              <h5 class="modal-title">Edit Student</h5>
              <button
                type="button"
                class="close text-white"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span>&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="editStudentId" />
              <div class="form-group">
                <label class="text-white">Name</label>
                <input
                  type="text"
                  id="editStudentName"
                  class="form-control bg-light text-dark"
                  required
                />
              </div>
              <div class="form-group">
                <label class="text-white">Subject</label>
                <input
                  type="text"
                  id="editStudentSubject"
                  class="form-control bg-light text-dark"
                  required
                />
              </div>
              <div class="form-group">
                <label class="text-white">Marks</label>
                <input
                  type="number"
                  id="editStudentMarks"
                  class="form-control bg-light text-dark"
                  required
                />
              </div>
            </div>
            <div class="modal-footer border-0">
              <button type="submit" class="btn btn-light btn-block w-100">
                Update
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script>
      function editRow(link) {
        const row = link.closest("tr");
        const id = row.dataset.id;
        const name = row.querySelector(".student-name").innerText.trim();
        const subject = row.querySelector(".student-subject").innerText.trim();
        const marks = row.querySelector(".student-marks").innerText.trim();

        document.getElementById("editStudentId").value = id;
        document.getElementById("editStudentName").value = name;
        document.getElementById("editStudentSubject").value = subject;
        document.getElementById("editStudentMarks").value = marks;

        $("#editStudentModal").modal("show");
      }

      document
        .getElementById("editStudentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const id = document.getElementById("editStudentId").value;
          const name = document.getElementById("editStudentName").value;
          const subject = document.getElementById("editStudentSubject").value;
          const marks = document.getElementById("editStudentMarks").value;

          fetch("/update_student/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ id, name, subject, marks }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                $("#editStudentModal").modal("hide");
                location.reload();
              } else {
                alert("Update failed: " + (data.error || ""));
              }
            });
        });

      function deleteStudent(id) {
        if (confirm("Are you sure you want to delete this student?")) {
          fetch(`/delete_student/${id}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                document.querySelector(`tr[data-id='${id}']`).remove();
              } else {
                alert("Failed to delete student");
              }
            });
        }
      }

      document
        .getElementById("addStudentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          fetch("/add_or_update_student/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({
              name: document.getElementById("studentName").value,
              subject: document.getElementById("studentSubject").value,
              marks: document.getElementById("studentMarks").value,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                $("#addStudentModal").modal("hide");
                location.reload();
              } else {
                alert("Error: " + data.error);
              }
            });
        });
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
